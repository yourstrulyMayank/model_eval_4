
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Validation Workbench - {{ model_name }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: hsl(0, 0%, 98%);
            color: hsl(0, 0%, 9%);
            min-height: 100vh;
        }

        header {
            border-bottom: 1px solid hsl(0, 0%, 93%);
            background: hsl(0, 0%, 100%);
        }

        .header-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header-content h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: hsl(0, 0%, 9%);
        }

        .header-content p {
            font-size: 0.875rem;
            color: hsl(0, 0%, 52.3%);
        }

        nav {
            border-bottom: 1px solid hsl(0, 0%, 93%);
            background: hsl(0, 0%, 100%);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .nav-links {
            display: flex;
            gap: 0.25rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: hsl(0, 0%, 52.3%);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
            background: transparent;
            border-top: none;
            border-left: none;
            border-right: none;
        }

        .nav-link:hover {
            color: hsl(0, 0%, 9%);
            border-bottom-color: hsl(0, 0%, 93%);
        }

        .nav-link.active {
            color: hsl(221.2, 83.2%, 53.3%);
            border-bottom-color: hsl(221.2, 83.2%, 53.3%);
        }

        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: hsl(0, 0%, 100%);
            border: 1px solid hsl(0, 0%, 93%);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .card p {
            color: hsl(0, 0%, 52.3%);
            font-size: 0.875rem;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .detail-item {
            padding: 1rem;
            background: hsl(0, 0%, 97.3%);
            border-radius: 0.375rem;
        }

        .detail-item h4 {
            font-size: 0.875rem;
            color: hsl(0, 0%, 52.3%);
            margin-bottom: 0.25rem;
        }

        .detail-item p {
            font-size: 1rem;
            font-weight: 600;
            color: hsl(0, 0%, 9%);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .data-table thead {
            background: hsl(0, 0%, 97.3%);
        }

        .data-table th {
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.875rem;
            font-weight: 600;
            color: hsl(0, 0%, 52.3%);
        }

        .data-table td {
            padding: 0.75rem 1rem;
            border-top: 1px solid hsl(0, 0%, 93%);
            font-size: 0.875rem;
        }

        .data-table tr:hover {
            background: hsl(0, 0%, 98%);
        }

        .badge {
            display: inline-flex;
            padding: 0.25rem 0.625rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: hsl(143, 85%, 96%);
            color: hsl(140, 100%, 27%);
        }

        .badge-warning {
            background: hsl(49, 100%, 97%);
            color: hsl(31, 92%, 45%);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, hsl(221.2, 83.2%, 95%), hsl(221.2, 83.2%, 98%));
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid hsl(221.2, 83.2%, 90%);
        }

        .stat-card h4 {
            font-size: 0.875rem;
            color: hsl(0, 0%, 52.3%);
            margin-bottom: 0.5rem;
        }

        .stat-card .value {
            font-size: 1.875rem;
            font-weight: 700;
            color: hsl(221.2, 83.2%, 53.3%);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-control {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid hsl(0, 0%, 93%);
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .btn-primary {
            padding: 0.625rem 1.5rem;
            background: hsl(221.2, 83.2%, 53.3%);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: hsl(221.2, 83.2%, 48%);
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .model-comparison {
            background: hsl(0, 0%, 100%);
            border: 2px solid hsl(0, 0%, 93%);
            border-radius: 0.5rem;
            padding: 1.5rem;
        }

        .model-comparison.champion {
            border-color: hsl(140, 100%, 27%);
        }

        .model-comparison.challenger {
            border-color: hsl(31, 92%, 45%);
        }

        .model-comparison h4 {
            font-size: 1.125rem;
            margin-bottom: 1rem;
        }

        /* Iframe Resizing */
        iframe {
            display: block;
            width: 100%;
            overflow: hidden;
        }
        
        /* Risk Matrix */
        .risk-matrix { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem; }
        .risk-cell { padding: 1rem; text-align: center; border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem; border: 1px solid transparent; }
        .risk-low { background: hsl(143, 85%, 96%); color: hsl(140, 100%, 27%); border-color: hsl(140, 100%, 80%); }
        .risk-med { background: hsl(49, 100%, 97%); color: hsl(31, 92%, 45%); border-color: hsl(31, 92%, 80%); }
        .risk-high { background: hsl(0, 100%, 97%); color: hsl(0, 92%, 45%); border-color: hsl(0, 92%, 80%); }

        @media (max-width: 768px) {
            .nav-links {
                flex-wrap: wrap;
            }

            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script>
        function resizeIframe(obj) {
            // Reset height to allow shrinking
            obj.style.height = '0px';
            // Set height to content
            obj.style.height = (obj.contentWindow.document.body.scrollHeight + 30) + 'px';
        }
    </script>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="header-content">
                <h1>Model Validation Workbench</h1>
            </div>
        </div>
    </header>

    <nav>
        <div class="nav-container">
            <div class="nav-links">
                <button class="nav-link active" onclick="switchMainTab('dashboard')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"></path>
                    </svg>
                    Validation Dashboard
                </button>
                <button class="nav-link" onclick="switchMainTab('loading')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" x2="12" y1="3" y2="15"></line>
                    </svg>
                    Model Loading
                </button>
                <button class="nav-link" onclick="switchMainTab('standard-eval')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"></path>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                    </svg>
                    Standard Evaluation
                </button>
                <button class="nav-link" onclick="switchMainTab('custom-eval')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                    </svg>
                    Custom Evaluation
                </button>
                <button class="nav-link" onclick="switchMainTab('benchmarks')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v16a2 2 0 0 0 2 2h16"></path>
                        <path d="M18 17V9"></path>
                        <path d="M13 17V5"></path>
                        <path d="M8 17v-3"></path>
                    </svg>
                    Benchmarks
                </button>
                <button class="nav-link" onclick="switchMainTab('comparison')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="18" r="3"></circle>
                        <circle cx="6" cy="6" r="3"></circle>
                        <path d="M13 6h3a2 2 0 0 1 2 2v7"></path>
                        <path d="M11 18H8a2 2 0 0 1-2-2V9"></path>
                    </svg>
                    Comparison
                </button>
            </div>
        </div>
    </nav>
    
    <main>
    <div id="dashboard-tab" class="tab-content active">
        <div class="card">
            <h1>{{ model_name.replace('_', ' ')|upper }} - {{ model_type|upper }}</h1>
            <h3>Model Details</h3>
            <div class="data-grid">
                <div class="detail-item">
                    <h4>Model Version</h4>
                    <p>{{ model_details.get('version', 'v1.0.0') }}</p>
                </div>
                <div class="detail-item">
                    <h4>Last Updated</h4>
                    <p>{{ model_details.get('last_updated', 'N/A') }}</p>
                </div>
                <div class="detail-item">
                    <h4>Framework</h4>
                    <p>{{ model_details.get('framework', 'Unknown') }}</p>
                </div>
                <div class="detail-item">
                    <h4>Status</h4>
                    <p><span class="badge badge-success">{{ model_details.get('status', 'Active') }}</span></p>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Scope Definition</h3>
            <div class="data-grid">
                <div class="detail-item">
                    <h4>Target Variable</h4>
                    <p>{{ model_details.get('scope', {}).get('target_variable', 'Capital Risk Score') }}</p>
                </div>
                <div class="detail-item">
                    <h4>Regulatory Framework</h4>
                    <p>{{ model_details.get('scope', {}).get('compliance_framework', 'Basel III / SR 11-7') }}</p>
                </div>
                <div class="detail-item">
                    <h4>Model Type</h4>
                    <p>{{ model_details.get('model_info', {}).get('problem_type', 'Regression') }}</p>
                </div>
                <div class="detail-item">
                    <h4>Business Use Case</h4>
                    <p>{{ model_details.get('scope', {}).get('business_use_case', 'Capital Adequacy & Risk Calculation') }}</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Data Validation</h3>
            <p style="margin-bottom: 1rem;">Validation metrics calculated from <code>dataset/test.csv</code></p>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Total Records</td>
                        <td>{{ "{:,}".format(model_details.get('data_validation', {}).get('total_records', 0)) }}</td>
                        <td><span class="badge badge-success">Pass</span></td>
                    </tr>
                    <tr>
                        <td>Missing Values</td>
                        <td>{{ model_details.get('data_validation', {}).get('missing_values', 0) }}%</td>
                        <td><span class="badge badge-success">Pass</span></td>
                    </tr>
                    <tr>
                        <td>Duplicate Records</td>
                        <td>{{ model_details.get('data_validation', {}).get('duplicate_records', 0) }}%</td>
                        <td><span class="badge badge-success">Pass</span></td>
                    </tr>
                    <tr>
                        <td>Outliers Detected (Z>3)</td>
                        <td>{{ model_details.get('data_validation', {}).get('outliers_detected', 0) }}%</td>
                        <td>
                            {% if model_details.get('data_validation', {}).get('outliers_detected', 0) > 5 %}
                            <span class="badge badge-warning">Review</span>
                            {% else %}
                            <span class="badge badge-success">Pass</span>
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="loading-tab" class="tab-content">
        <div class="card">
            <h3>Current Model Configuration</h3>
            <p style="margin-bottom: 1rem;">Parameters extracted from the currently active model file.</p>
            
            <div style="max-height: 400px; overflow-y: auto; border: 1px solid hsl(0, 0%, 93%); border-radius: 0.375rem;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="position: sticky; top: 0; background: hsl(0, 0%, 97.3%); z-index: 1;">Parameter</th>
                            <th style="position: sticky; top: 0; background: hsl(0, 0%, 97.3%); z-index: 1;">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set params = model_details.get('model_parameters', {}) %}
                        {% if params and params is mapping %}
                            {% for key, value in params.items() %}
                            <tr>
                                <td style="font-family: monospace; font-weight: 600;">{{ key }}</td>
                                <td style="font-family: monospace;">{{ value }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="2" style="text-align: center; color: hsl(0, 0%, 52.3%); padding: 2rem;">
                                    No parameters found. Run evaluation to populate.
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>Upload New Version</h3>
            <p style="margin-bottom: 1rem; color: hsl(0, 0%, 52.3%);">
                Uploading a new model here will <strong>void</strong> the current model (renaming it to <code>model_void</code>) and increment the model version in <code>details.json</code>.
            </p>
            
            <form id="versionUploadForm" onsubmit="handleVersionUpload(event)">
                <div class="form-group">
                    <label>New Model File (.pkl, .joblib)</label>
                    <input type="file" name="model_file" class="form-control" accept=".pkl,.joblib,.model" required>
                </div>

                <div class="form-group">
                    <label>New Test Dataset (.csv)</label>
                    <input type="file" name="test_file" class="form-control" accept=".csv" required>
                </div>

                <div id="version-upload-status" style="margin-bottom: 1rem;"></div>

                <button type="submit" class="btn-primary">Upload & Update Version</button>
            </form>
        </div>
    </div>

    <div id="standard-eval-tab" class="tab-content">
        <div class="card">
            <div id="standard-loading" style="text-align: center; padding: 40px;">
                <div style="display: inline-block; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p style="margin-top: 20px; font-size: 1.2em; color: #666;">Starting standard evaluation...</p>
            </div>
            <div id="standard-content" style="display: none;">
                <iframe id="standard-eval-frame" src="" style="width: 100%; border: none; min-height: 800px;" onload="resizeIframe(this)"></iframe>
            </div>
        </div>
    </div>

    <div id="custom-eval-tab" class="tab-content">
        <div class="card">
            <div id="custom-content">
                <iframe id="custom-eval-frame" src="" style="width: 100%; border: none; min-height: 800px;" onload="resizeIframe(this)"></iframe>
            </div>
        </div>
    </div>

    <div id="benchmarks-tab" class="tab-content">
        <div class="stats-grid">
            <div class="stat-card">
                <h4>Overall Score</h4>
                <div class="value">{{ model_details.get('benchmarks', {}).get('overall_score', 88) }}%</div>
            </div>
            <div class="stat-card">
                <h4>Primary Metric</h4>
                <div class="value">{{ model_details.get('benchmarks', {}).get('primary_metric', 0.88) }}</div>
            </div>
        </div>

        <div class="card">
            <h3>Recorded Benchmarks</h3>
            <p style="margin-bottom: 1rem; color: hsl(0, 0%, 52.3%);">Metrics recorded in <code>details.json</code> from the latest evaluation.</p>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Current Value</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key, val in model_details.get('benchmarks', {}).items() %}
                    {% if key not in ['overall_score', 'tests_passed', 'primary_metric'] %}
                    <tr>
                        <td style="text-transform: capitalize;">{{ key.replace('_', ' ') }}</td>
                        <td>{{ val }}</td>
                        <td><span class="badge badge-success">Recorded</span></td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div id="comparison-tab" class="tab-content">
        <div class="card">
            <h3>Champion vs Challenger</h3>
            <p style="margin-bottom: 1rem; color: hsl(0, 0%, 52.3%);">
                Compare the current Production model (Champion) against a new candidate uploaded to memory.
            </p>
        </div>

        <div class="comparison-grid">
            <div class="model-comparison champion">
                <h4>üèÜ Champion (Production)</h4>
                <div class="data-grid" style="grid-template-columns: 1fr;">
                    <div class="detail-item">
                        <h4>Version</h4>
                        <p>{{ model_details.get('version', 'v1.0.0') }}</p>
                    </div>
                    {% for key, val in model_details.get('benchmarks', {}).items() %}
                    {% if key in ['r2_score', 'rmse', 'mae', 'accuracy', 'precision', 'f1_score'] %}
                    <div class="detail-item">
                        <h4>{{ key }}</h4>
                        <p id="champ-{{ key }}">{{ val }}</p>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="model-comparison challenger">
                <h4>‚ö° Challenger (Candidate)</h4>
                
                <form id="memoryEvalForm" onsubmit="handleMemoryEval(event)" style="margin-bottom: 1.5rem; background: hsl(0,0%,98%); padding: 1rem; border-radius: 0.5rem; border:1px solid hsl(0,0%,90%);">
                    <div class="form-group">
                        <label style="font-size: 0.8rem;">Upload Challenger Model (.pkl) - Memory Only</label>
                        <input type="file" name="model_file" class="form-control" accept=".pkl" required>
                    </div>
                    <button type="submit" class="btn-primary" id="memEvalBtn">Evaluate Candidate</button>
                </form>

                <div id="challenger-results" style="display: none;">
                    <div class="data-grid" style="grid-template-columns: 1fr;" id="challenger-metrics-grid">
                        </div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 2rem;">
            <h3>Production Risk Assessment</h3>
            <div class="risk-matrix">
                <div class="risk-cell risk-low">
                    Model Drift Risk<br>LOW
                </div>
                <div class="risk-cell risk-med">
                    Data Quality Risk<br>MEDIUM
                </div>
                <div class="risk-cell risk-low">
                    Regulatory Risk<br>LOW
                </div>
            </div>
            
            <div style="margin-top: 1.5rem;">
                <h4>Risk Statement</h4>
                <p style="line-height: 1.6; color: hsl(0, 0%, 30%); font-size: 0.9rem;">
                    The current Champion model version <strong>{{ model_details.get('version') }}</strong> operates within defined risk tolerance levels. 
                    The data validation flags potential outliers in the test set which contributes to a MEDIUM Data Quality risk. 
                    However, the Regulatory Risk remains LOW as per SR 11-7 compliance checks. 
                    Any Challenger model showing >5% variance in RMSE/Accuracy should trigger a full Model Risk Management (MRM) review before promotion.
                </p>
            </div>
        </div>
    </div>
    
    <button onclick="window.history.back()" style="padding: 0.5rem 1rem; margin-top: 2rem; border-radius: 0.375rem; background: hsl(221.2, 83.2%, 53.3%); color: white; border: none; font-size: 0.875rem; font-weight: 600; cursor: pointer;">
        ‚Üê Back
    </button>
</main>
   <script>
    const MODEL_NAME = '{{ model_name }}';
    let standardEvalStarted = false;
    let customEvalLoaded = false;

    function switchMainTab(tabName) {
        // UI Updates
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        event.target.closest('.nav-link').classList.add('active');
        document.getElementById(tabName + '-tab').classList.add('active');
        
        // Tab Specific Actions
        if (tabName === 'standard-eval' && !standardEvalStarted) {
            standardEvalStarted = true;
            startStandardEvaluation();
        }
        
        if (tabName === 'custom-eval' && !customEvalLoaded) {
            customEvalLoaded = true;
            loadCustomEvaluation();
        }
    }

    // --- Standard Eval Logic ---
    function startStandardEvaluation() {
        document.getElementById('standard-loading').style.display = 'block';
        document.getElementById('standard-content').style.display = 'none';
        
        fetch(`/api/start_evaluation/${MODEL_NAME}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'started') {
                // Auto start standard eval tool
                const frame = document.getElementById('standard-eval-frame');
                frame.src = `/tool_evaluate_ml/${MODEL_NAME}?autostart=true`;
                
                // Show content after slight delay
                setTimeout(() => {
                    document.getElementById('standard-loading').style.display = 'none';
                    document.getElementById('standard-content').style.display = 'block';
                }, 1000);
            } else {
                alert('Failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => alert('Error: ' + error.message));
    }

    function loadCustomEvaluation() {
        document.getElementById('custom-eval-frame').src = `/custom_evaluate_ml/${MODEL_NAME}`;
    }

    // --- Version Upload (Voiding Logic) ---
    async function handleVersionUpload(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const statusDiv = document.getElementById('version-upload-status');
        statusDiv.innerHTML = '<span style="color: hsl(221.2, 83.2%, 53.3%)">Uploading and Archiving old version...</span>';
        
        try {
            const res = await fetch(`/api/upload_new_model_version/${MODEL_NAME}`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            
            if (data.status === 'success') {
                statusDiv.innerHTML = `<span style="color: hsl(140, 100%, 27%)">${data.message} Reloading...</span>`;
                setTimeout(() => window.location.reload(), 1500);
            } else {
                statusDiv.innerHTML = `<span style="color: hsl(0, 92%, 45%)">Error: ${data.message}</span>`;
            }
        } catch (err) {
            statusDiv.innerHTML = `<span style="color: hsl(0, 92%, 45%)">Network Error</span>`;
        }
    }

    // --- Memory Evaluation (Comparison Logic) ---
    async function handleMemoryEval(e) {
        e.preventDefault();
        const btn = document.getElementById('memEvalBtn');
        const formData = new FormData(e.target);
        const container = document.getElementById('challenger-metrics-grid');
        const resultsArea = document.getElementById('challenger-results');
        
        btn.disabled = true;
        btn.textContent = 'Evaluating...';
        
        try {
            const res = await fetch(`/api/evaluate_memory_model/${MODEL_NAME}`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            
            if (data.status === 'success') {
                container.innerHTML = '';
                resultsArea.style.display = 'block';
                
                // Metrics to display
                const targetMetrics = ['r2_score', 'rmse', 'mae', 'accuracy', 'precision_weighted', 'f1_weighted'];
                // Mappings for UI keys vs API keys
                const keyMap = {
                    'r2': 'r2_score', 'precision_weighted': 'precision', 'f1_weighted': 'f1_score'
                };

                for (const [apiKey, val] of Object.entries(data.metrics)) {
                    // Check if this metric is interesting
                    // Handle mismatched naming (e.g. API returns 'r2', UI wants 'r2_score')
                    let uiKey = keyMap[apiKey] || apiKey;
                    
                    if (targetMetrics.includes(uiKey) || targetMetrics.includes(apiKey)) {
                        let displayVal = typeof val === 'number' ? val.toFixed(4) : val;
                        
                        // Try to find champion value for Delta calculation
                        let champVal = null;
                        const champEl = document.getElementById(`champ-${uiKey}`);
                        if (champEl) champVal = parseFloat(champEl.innerText);
                        
                        let deltaHtml = '';
                        if (champVal !== null && typeof val === 'number') {
                            const diff = val - champVal;
                            const color = diff > 0 ? 'hsl(140, 100%, 27%)' : 'hsl(0, 92%, 45%)'; // Naive coloring
                            deltaHtml = `<span style="color:${color}; font-size:0.8rem; margin-left:0.5rem;">(${diff > 0 ? '+' : ''}${diff.toFixed(4)})</span>`;
                        }

                        container.innerHTML += `
                            <div class="detail-item">
                                <h4>${uiKey}</h4>
                                <p>${displayVal} ${deltaHtml}</p>
                            </div>
                        `;
                    }
                }
            } else {
                alert('Evaluation Error: ' + data.error);
            }
        } catch (err) {
            alert('Error: ' + err);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Evaluate Candidate';
        }
    }
    
    // Resize script handles itself via onload attribute
</script>
</body>
</html>
