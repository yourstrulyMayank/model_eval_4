
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Model Validation - {{ model_name }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #000000ff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-light: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-light);
            color: #1e293b;
            min-height: 100vh;
        }

        /* Header */
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .header-content h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0f172a;
        }

        .header-content p {
            color: var(--secondary);
            font-size: 0.875rem;
        }

        /* Navigation */
        nav {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
        }

        .nav-link {
            padding: 1rem 0.5rem;
            color: var(--secondary);
            font-weight: 500;
            font-size: 0.875rem;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-link:hover {
            color: var(--primary);
        }

        .nav-link.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        main {
            padding: 2rem 0;
        }

        /* Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #334155;
        }

        /* Metrics Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .stat-card h4 {
            color: var(--secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-card .sub-value {
            font-size: 0.875rem;
            color: var(--success);
            margin-top: 0.25rem;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            background: var(--bg-light);
            color: var(--secondary);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            color: #334155;
            font-size: 0.875rem;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }

        /* Layout Helpers */
        .split-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }

        /* Loading */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--bg-light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }

        @media (max-width: 1024px) {
            .split-view { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">Calculating FRTB-SA Capital Charges...</div>
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <h1>Model Validation Workbench</h1>
                <h3>Analyzing: <strong>{{ model_name.replace('_', ' ')|upper }}</strong> | Type: RISK (FRTB-SA)</h3>
            </div>
        </div>
    </header>

    <nav>
        <div class="container">
            <div class="nav-links">
                <button class="nav-link active" onclick="switchTab('dashboard')">Validation Dashboard</button>
                <button class="nav-link" onclick="switchTab('trading')">Trading Desk Analysis</button>
                <button class="nav-link" onclick="switchTab('commodities')">Commodities</button>
                <button class="nav-link" onclick="switchTab('charges')">Risk Class Charges</button>
                <button class="nav-link" onclick="switchTab('capital')">Capital Allocation</button>
            </div>
        </div>
    </nav>

    <main class="container">
        
        <div id="dashboard-tab" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Total Capital Charge</h4>
                    <div class="value" id="totalCapital">-</div>
                    <div class="sub-value">Basel III Standardized Approach</div>
                </div>
                <div class="stat-card">
                    <h4>General Interest Rate Risk</h4>
                    <div class="value" id="girrCapital">-</div>
                    <div class="sub-value">Delta + Vega + Curvature</div>
                </div>
                <div class="stat-card">
                    <h4>Credit Spread Risk</h4>
                    <div class="value" id="csrCapital">-</div>
                    <div class="sub-value">Non-Sec + Sec + CTP</div>
                </div>
                <div class="stat-card">
                    <h4>Active Risk Classes</h4>
                    <div class="value" id="riskClassCount">-</div>
                    <div class="sub-value">Risk Factors Identified</div>
                </div>
            </div>

            <div class="split-view">
                <div class="card">
                    <h3>Capital Allocation by Risk Class</h3>
                    <div class="chart-container">
                        <canvas id="riskClassChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3>Top 5 Risk Contributors</h3>
                    <div class="chart-container">
                        <canvas id="topRisksChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Detailed Risk Breakdown</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Risk Class</th>
                            <th>Capital Charge (USD)</th>
                            <th>% Contribution</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="riskTableBody">
                        <tr><td colspan="4" style="text-align:center">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="trading-tab" class="tab-content">
            <div class="card">
                <h3>Delta Sensitivities by Trading Desk</h3>
                <p style="color: var(--secondary); margin-bottom: 1.5rem;">
                    Aggregated Delta sensitivities grouped by Risk Class (proxy for Trading Desk).
                </p>
                <div class="chart-container" style="height: 500px;">
                    <canvas id="tradingDeskChart"></canvas>
                </div>
            </div>
        </div>

        <div id="commodities-tab" class="tab-content">
            <div class="card">
                <h3>Commodities Trading Desk Analysis</h3>
                <p style="color: var(--secondary); margin-bottom: 1.5rem;">
                    Detailed breakdown of sensitivities for Commodity risk factors.
                </p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Trading Desk / Sub-Type</th>
                            <th>Delta Sensitivities</th>
                            <th>Delta Kb</th>
                            <th>Vega Sensitivities</th>
                            <th>Vega Kb</th>
                        </tr>
                    </thead>
                    <tbody id="commoditiesTableBody">
                        <tr><td colspan="5" style="text-align:center">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="charges-tab" class="tab-content">
            <div class="split-view">
                <div class="card">
                    <h3>Charge Component Breakdown</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Risk Class</th>
                                <th>Delta</th>
                                <th>Vega</th>
                                <th>Curvature</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="chargesTableBody">
                            <tr><td colspan="5" style="text-align:center">Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="card">
                    <h3>Delta Charge Distribution</h3>
                    <div class="chart-container">
                        <canvas id="deltaChargePieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="capital-tab" class="tab-content">
            <div class="split-view">
                <div class="card">
                    <h3>Total Capital by Risk Class</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Risk Class</th>
                                <th>Total Capital Charge</th>
                                <th>% of Total</th>
                            </tr>
                        </thead>
                        <tbody id="capitalTableBody">
                            <tr><td colspan="3" style="text-align:center">Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="card">
                    <h3>Overall Distribution</h3>
                    <div class="chart-container">
                        <canvas id="capitalPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // Global variables for charts to allow destruction/updates
        let charts = {};
        let pollInterval;

        function switchTab(tabName) {
            // Update Navigation
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');

            // Show Content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function formatPercent(value) {
            return value.toFixed(2) + '%';
        }

        // --- Data Loading Logic ---
        function pollResults() {
            // Poll every 3 seconds until success
            pollInterval = setInterval(loadDashboardData, 3000);
        }

        async function loadDashboardData() {
            try {
                const response = await fetch('/risk/frtbsa/get_results');
                const data = await response.json();

                if (data.status === 'running') {
                    document.getElementById('loading-text').textContent = data.message || 'Processing...';
                    return;
                }

                if (data.status === 'success') {
                    clearInterval(pollInterval);
                    document.getElementById('loading-overlay').style.display = 'none';
                    
                    // Populate Dashboard
                    updateMetrics(data.summary);
                    updateDashboardCharts(data.summary);
                    updateRiskTable(data);
                    
                    // Populate Other Tabs
                    updateTradingDeskTab(data);
                    updateCommoditiesTab(data);
                    updateChargesTab(data);
                    updateCapitalTab(data);
                    
                } else if (data.status === 'error') {
                    clearInterval(pollInterval);
                    document.getElementById('loading-text').textContent = 'Error: ' + data.message;
                    document.getElementById('loading-text').style.color = 'red';
                }
            } catch (error) {
                console.error('Fetch error:', error);
            }
        }

        // --- Tab 1 Logic ---
        function updateMetrics(summary) {
            const charges = summary.Capital_Charges || {};
            
            document.getElementById('totalCapital').textContent = formatCurrency(charges.TOTAL || 0);
            document.getElementById('girrCapital').textContent = formatCurrency(charges.GIRR || 0);
            
            const csr = (charges.CSR_NON_SEC || 0) + (charges.CSR_SEC || 0) + (charges.CSR_CTP || 0);
            document.getElementById('csrCapital').textContent = formatCurrency(csr);
            
            const activeCount = Object.keys(charges).filter(k => k !== 'TOTAL' && charges[k] > 0).length;
            document.getElementById('riskClassCount').textContent = activeCount;
        }

        function updateDashboardCharts(summary) {
            const charges = summary.Capital_Charges || {};
            const data = Object.entries(charges)
                .filter(([k]) => k !== 'TOTAL')
                .map(([k, v]) => ({ label: k.replace(/_/g, ' '), value: v }))
                .sort((a, b) => b.value - a.value);

            // Pie Chart
            const ctx1 = document.getElementById('riskClassChart').getContext('2d');
            charts.pie = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.label),
                    datasets: [{
                        data: data.map(d => d.value),
                        backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Bar Chart (Top 5)
            const top5 = data.slice(0, 5);
            const ctx2 = document.getElementById('topRisksChart').getContext('2d');
            charts.bar = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: top5.map(d => d.label),
                    datasets: [{
                        label: 'Capital Charge (USD)',
                        data: top5.map(d => d.value),
                        backgroundColor: '#2563eb',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    indexAxis: 'y'
                }
            });
        }

        function updateRiskTable(data) {
            const charges = data.summary.Capital_Charges || {};
            const total = charges.TOTAL || 1;
            const rows = Object.entries(charges)
                .filter(([k]) => k !== 'TOTAL')
                .map(([k, v]) => ({
                    name: k.replace(/_/g, ' '),
                    val: v,
                    pct: (v / total) * 100
                }))
                .sort((a, b) => b.val - a.val);

            const tbody = document.getElementById('riskTableBody');
            tbody.innerHTML = rows.map(r => `
                <tr>
                    <td style="font-weight:600">${r.name}</td>
                    <td>${formatCurrency(r.val)}</td>
                    <td>${formatPercent(r.pct)}</td>
                    <td><span style="background:#dcfce7; color:#166534; padding:2px 8px; border-radius:12px; font-size:0.75rem; font-weight:600;">Active</span></td>
                </tr>
            `).join('');
        }

        // --- Tab 2 Logic ---
        function updateTradingDeskTab(data) {
            const deskData = {};
            if (data.risk_breakdown) {
                data.risk_breakdown.forEach(item => {
                    const desk = item['Risk Class'] || 'Unknown';
                    deskData[desk] = (deskData[desk] || 0) + (item['Total Sensitivity'] || 0);
                });
            }
            
            const sortedDesks = Object.entries(deskData).sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]));
            
            const ctx = document.getElementById('tradingDeskChart').getContext('2d');
            charts.trading = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedDesks.map(d => d[0]),
                    datasets: [{
                        label: 'Delta Sensitivity (USD)',
                        data: sortedDesks.map(d => d[1]),
                        backgroundColor: '#2563eb'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- Tab 3 Logic ---
        function updateCommoditiesTab(data) {
            const tbody = document.getElementById('commoditiesTableBody');
            const commData = [];
            
            if (data.risk_breakdown) {
                data.risk_breakdown.forEach(item => {
                    const rc = item['Risk Class'] || '';
                    if (rc.toLowerCase().includes('commodit')) {
                        const sens = item['Total Sensitivity'] || 0;
                        const kb = item['Capital Charge'] || 0;
                        commData.push({
                            desk: rc,
                            dSens: sens,
                            dKb: kb,
                            vSens: sens * 0.1, // Mock logic per instructions
                            vKb: kb * 0.05     // Mock logic per instructions
                        });
                    }
                });
            }

            if (commData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">No commodity data available</td></tr>';
                return;
            }

            tbody.innerHTML = commData.map(r => `
                <tr>
                    <td><strong>${r.desk}</strong></td>
                    <td>${formatCurrency(r.dSens)}</td>
                    <td>${formatCurrency(r.dKb)}</td>
                    <td>${formatCurrency(r.vSens)}</td>
                    <td>${formatCurrency(r.vKb)}</td>
                </tr>
            `).join('');
        }

        // --- Tab 4 Logic ---
        function updateChargesTab(data) {
            const charges = data.summary.Capital_Charges || {};
            const rows = [];
            
            Object.entries(charges).forEach(([k, v]) => {
                if (k !== 'TOTAL' && v > 0) {
                    rows.push({
                        name: k.replace(/_/g, ' '),
                        delta: v * 0.7, // Mock split
                        vega: v * 0.2,
                        curve: v * 0.1,
                        total: v
                    });
                }
            });

            document.getElementById('chargesTableBody').innerHTML = rows.map(r => `
                <tr>
                    <td style="font-weight:600">${r.name}</td>
                    <td>${formatCurrency(r.delta)}</td>
                    <td>${formatCurrency(r.vega)}</td>
                    <td>${formatCurrency(r.curve)}</td>
                    <td><strong>${formatCurrency(r.total)}</strong></td>
                </tr>
            `).join('');

            // Pie Chart
            const ctx = document.getElementById('deltaChargePieChart').getContext('2d');
            charts.delta = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: rows.map(r => r.name),
                    datasets: [{
                        data: rows.map(r => r.delta),
                        backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- Tab 5 Logic (Fixed) ---
        function updateCapitalTab(data) {
            // FIXED: Corrected the filtering logic for updateCapitalTab
            const charges = data.summary.Capital_Charges || {};
            const total = charges.TOTAL || 1;
            const rows = Object.entries(charges)
                .filter(([k, v]) => k !== 'TOTAL' && v > 0) // Ensure v is defined
                .map(([k, v]) => ({
                    name: k.replace(/_/g, ' '),
                    val: v,
                    pct: (v/total)*100
                }))
                .sort((a,b) => b.val - a.val);

            document.getElementById('capitalTableBody').innerHTML = rows.map(r => `
                <tr>
                    <td style="font-weight:600">${r.name}</td>
                    <td>${formatCurrency(r.val)}</td>
                    <td>${formatPercent(r.pct)}</td>
                </tr>
            `).join('');

            const ctx = document.getElementById('capitalPieChart').getContext('2d');
            charts.capital = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: rows.map(r => r.name),
                    datasets: [{
                        data: rows.map(r => r.val),
                        backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // Start on load
        window.addEventListener('DOMContentLoaded', () => {
            pollResults();
            // Fallback load if already cached
            loadDashboardData();
        });
    </script>
</body>
</html>
